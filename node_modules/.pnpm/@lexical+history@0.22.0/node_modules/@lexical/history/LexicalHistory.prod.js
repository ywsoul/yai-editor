/**
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 *
 */

'use strict';var d=require("@lexical/utils"),u=require("lexical");
function v(b,a,k,g,f){if(null===b||0===k.size&&0===g.size&&!f)return 0;var c=a._selection,e=b._selection;if(f)return 1;if(!(u.$isRangeSelection(c)&&u.$isRangeSelection(e)&&e.isCollapsed()&&c.isCollapsed()))return 0;f=a._nodeMap;let h=[];for(let m of k)k=f.get(m),void 0!==k&&h.push(k);for(let [m,l]of g)l&&(g=f.get(m),void 0===g||u.$isRootNode(g)||h.push(g));if(0===h.length)return 0;if(1<h.length)return g=a._nodeMap,a=g.get(c.anchor.key),e=g.get(e.anchor.key),a&&e&&!b._nodeMap.has(a.__key)&&u.$isTextNode(a)&&
1===a.__text.length&&1===c.anchor.offset?2:0;a=h[0];b=b._nodeMap.get(a.__key);if(!u.$isTextNode(b)||!u.$isTextNode(a)||b.__mode!==a.__mode)return 0;b=b.__text;a=a.__text;if(b===a)return 0;c=c.anchor;e=e.anchor;if(c.key!==e.key||"text"!==c.type)return 0;c=c.offset;e=e.offset;b=a.length-b.length;return 1===b&&e===c-1?2:-1===b&&e===c+1?3:-1===b&&e===c?4:0}
function w(b,a,k){let g=a._nodeMap.get(b),f=k._nodeMap.get(b);b=a._selection;let c=k._selection;return u.$isRangeSelection(b)&&u.$isRangeSelection(c)&&"element"===b.anchor.type&&"element"===b.focus.type&&"text"===c.anchor.type&&"text"===c.focus.type||!u.$isTextNode(g)||!u.$isTextNode(f)||g.__parent!==f.__parent?!1:JSON.stringify(a.read(()=>g.exportJSON()))===JSON.stringify(k.read(()=>f.exportJSON()))}
function x(b,a){let k=Date.now(),g=0;return(f,c,e,h,m,l)=>{let n=Date.now();if(l.has("historic"))return g=0,k=n,2;let p=v(f,c,h,m,b.isComposing()),r=(()=>{var q=null===e||e.editor===b;const t=l.has("history-push");if(!t&&q&&l.has("history-merge"))return 0;if(null===f)return 1;const y=c._selection;return 0<h.size||0<m.size?!1===t&&0!==p&&p===g&&n<k+a&&q||1===h.size&&(q=Array.from(h)[0],w(q,f,c))?0:1:null!==y?0:2})();k=n;g=p;return r}}
exports.createEmptyHistoryState=function(){return{current:null,redoStack:[],undoStack:[]}};
exports.registerHistory=function(b,a,k){let g=x(b,k);return d.mergeRegister(b.registerCommand(u.UNDO_COMMAND,()=>{let f=a.redoStack,c=a.undoStack;if(0!==c.length){let e=a.current,h=c.pop();null!==e&&(f.push(e),b.dispatchCommand(u.CAN_REDO_COMMAND,!0));0===c.length&&b.dispatchCommand(u.CAN_UNDO_COMMAND,!1);a.current=h||null;h&&h.editor.setEditorState(h.editorState,{tag:"historic"})}return!0},u.COMMAND_PRIORITY_EDITOR),b.registerCommand(u.REDO_COMMAND,()=>{let f=a.redoStack;var c=a.undoStack;if(0!==
f.length){let e=a.current;null!==e&&(c.push(e),b.dispatchCommand(u.CAN_UNDO_COMMAND,!0));c=f.pop();0===f.length&&b.dispatchCommand(u.CAN_REDO_COMMAND,!1);a.current=c||null;c&&c.editor.setEditorState(c.editorState,{tag:"historic"})}return!0},u.COMMAND_PRIORITY_EDITOR),b.registerCommand(u.CLEAR_EDITOR_COMMAND,()=>{a.undoStack=[];a.redoStack=[];a.current=null;return!1},u.COMMAND_PRIORITY_EDITOR),b.registerCommand(u.CLEAR_HISTORY_COMMAND,()=>{a.undoStack=[];a.redoStack=[];a.current=null;b.dispatchCommand(u.CAN_REDO_COMMAND,
!1);b.dispatchCommand(u.CAN_UNDO_COMMAND,!1);return!0},u.COMMAND_PRIORITY_EDITOR),b.registerUpdateListener(({editorState:f,prevEditorState:c,dirtyLeaves:e,dirtyElements:h,tags:m})=>{const l=a.current,n=a.redoStack,p=a.undoStack,r=null===l?null:l.editorState;if(null===l||f!==r){c=g(c,f,l,e,h,m);if(1===c)0!==n.length&&(a.redoStack=[],b.dispatchCommand(u.CAN_REDO_COMMAND,!1)),null!==l&&(p.push({...l}),b.dispatchCommand(u.CAN_UNDO_COMMAND,!0));else if(2===c)return;a.current={editor:b,editorState:f}}}))}
