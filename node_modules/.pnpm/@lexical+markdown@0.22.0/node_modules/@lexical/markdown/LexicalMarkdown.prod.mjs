/**
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 *
 */

import{$isParagraphNode as t,$isTextNode as e,$getRoot as n,$isElementNode as o,$isDecoratorNode as r,$isLineBreakNode as i,$getSelection as s,$createTextNode as l,$createParagraphNode as c,$createLineBreakNode as a,$isRangeSelection as f,$isRootOrShadowRoot as u,$createRangeSelection as g,$setSelection as p}from"lexical";import{$isListNode as h,$isListItemNode as d,ListNode as m,ListItemNode as x,$createListItemNode as T,$createListNode as E}from"@lexical/list";import{$isQuoteNode as C,HeadingNode as y,$isHeadingNode as v,QuoteNode as b,$createQuoteNode as S,$createHeadingNode as w}from"@lexical/rich-text";import{$findMatchingParent as $}from"@lexical/utils";import{$isCodeNode as F,CodeNode as P,$createCodeNode as k}from"@lexical/code";import{LinkNode as M,$isLinkNode as L,$createLinkNode as R}from"@lexical/link";function _(t,e){const n={};for(const o of t){const t=e(o);t&&(n[t]?n[t].push(o):n[t]=[o])}return n}function N(t){const e=_(t,(t=>t.type));return{element:e.element||[],multilineElement:e["multiline-element"]||[],textFormat:e["text-format"]||[],textMatch:e["text-match"]||[]}}const j=/[!-/:-@[-`{-~\s]/,I=/^\s{0,3}$/;function z(n){if(!t(n))return!1;const o=n.getFirstChild();return null==o||1===n.getChildrenSize()&&e(o)&&I.test(o.getTextContent())}function A(t,e,n,i){for(const o of e){if(!o.export)continue;const e=o.export(t,(t=>B(t,n,i)));if(null!=e)return e}return o(t)?B(t,n,i):r(t)?t.getTextContent():null}function B(t,n,s){const l=[],c=t.getChildren(),a=[];t:for(const t of c){for(const e of s){if(!e.export)continue;const o=e.export(t,(t=>B(t,n,s)),((t,e)=>W(t,e,n,a)));if(null!=o){l.push(o);continue t}}i(t)?l.push("\n"):e(t)?l.push(W(t,t.getTextContent(),n,a)):o(t)?l.push(B(t,n,s)):r(t)&&l.push(t.getTextContent())}return l.join("")}function W(t,e,n,o){const r=e.trim();let i=r,s="",l="";const c=U(t,!0),a=U(t,!1),f=new Set;for(const e of n){const n=e.format[0],r=e.tag;D(t,n)&&!f.has(n)&&(f.add(n),D(c,n)&&o.find((t=>t.tag===r))||(o.push({format:n,tag:r}),s+=r))}for(let t=0;t<o.length;t++)if(!D(a,o[t].format)){for(;o.length>t;){const t=o.pop();t&&"string"==typeof t.tag&&(l+=t.tag)}break}return i=s+i+l,e.replace(r,(()=>i))}function U(t,n){let r=n?t.getPreviousSibling():t.getNextSibling();if(!r){const e=t.getParentOrThrow();e.isInline()&&(r=n?e.getPreviousSibling():e.getNextSibling())}for(;r;){if(o(r)){if(!r.isInline())break;const t=n?r.getLastDescendant():r.getFirstDescendant();if(e(t))return t;r=n?r.getPreviousSibling():r.getNextSibling()}if(e(r))return r;if(!o(r))return null}return null}function D(t,n){return e(t)&&t.hasFormat(n)}const O="undefined"!=typeof window&&void 0!==window.document&&void 0!==window.document.createElement,K=O&&"documentMode"in document?document.documentMode:null;O&&"InputEvent"in window&&!K&&new window.InputEvent("input");const V=O&&/Version\/[\d.]+.*Safari/.test(navigator.userAgent),q=O&&/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream,G=O&&/^(?=.*Chrome).*/i.test(navigator.userAgent),H=O&&/AppleWebKit\/[\d.]+/.test(navigator.userAgent)&&!G;function J(t,e=!1){const o=N(t),r=function(t){const e={},n={},o=[],r="(?<![\\\\])";for(const r of t){const{tag:t}=r;e[t]=r;const i=t.replace(/(\*|\^|\+)/g,"\\$1");o.push(i),n[t]=V||q||H?new RegExp(`(${i})(?![${i}\\s])(.*?[^${i}\\s])${i}(?!${i})`):new RegExp(`(?<![\\\\${i}])(${i})((\\\\${i})?.*?[^${i}\\s](\\\\${i})?)((?<!\\\\)|(?<=\\\\\\\\))(${i})(?![\\\\${i}])`)}return{fullMatchRegExpByTag:n,openTagsRegExp:new RegExp((V||q||H?"":`${r}`)+"("+o.join("|")+")","g"),transformersByTag:e}}(o.textFormat);return(t,i)=>{const l=t.split("\n"),c=l.length,a=i||n();a.clear();for(let t=0;t<c;t++){const e=l[t],[n,i]=Q(l,t,o.multilineElement,a);n?t=i:X(e,a,o.element,r,o.textMatch)}const f=a.getChildren();for(const t of f)!e&&z(t)&&a.getChildrenSize()>1&&t.remove();null!==s()&&a.selectStart()}}function Q(t,e,n,o){for(const r of n){const{handleImportAfterStartMatch:n,regExpEnd:i,regExpStart:s,replace:l}=r,c=t[e].match(s);if(!c)continue;if(n){const i=n({lines:t,rootNode:o,startLineIndex:e,startMatch:c,transformer:r});if(null===i)continue;if(i)return i}const a="object"==typeof i&&"regExp"in i?i.regExp:i,f=i&&"object"==typeof i&&"optional"in i?i.optional:!i;let u=e;const g=t.length;for(;u<g;){const n=a?t[u].match(a):null;if(!n&&(!f||f&&u<g-1)){u++;continue}if(n&&e===u&&n.index===c.index){u++;continue}const r=[];if(n&&e===u)r.push(t[e].slice(c[0].length,-n[0].length));else for(let o=e;o<=u;o++)if(o===e){const e=t[o].slice(c[0].length);r.push(e)}else if(o===u&&n){const e=t[o].slice(0,-n[0].length);r.push(e)}else r.push(t[o]);if(!1!==l(o,null,c,n,r,!0))return[!0,u];break}}return[!1,e]}function X(e,n,o,r,i){const s=l(e),f=c();f.append(s),n.append(f);for(const{regExp:t,replace:n}of o){const o=e.match(t);if(o&&(s.setTextContent(e.slice(o[0].length)),!1!==n(f,[s],o,!0)))break}if(Y(s,r,i),f.isAttached()&&e.length>0){const e=f.getPreviousSibling();if(t(e)||C(e)||h(e)){let t=e;if(h(e)){const n=e.getLastDescendant();t=null==n?null:$(n,d)}null!=t&&t.getTextContentSize()>0&&(t.splice(t.getChildrenSize(),0,[a(),...f.getChildren()]),f.remove())}}}function Y(t,e,n){const o=t.getTextContent(),r=function(t,e){const n=t.match(e.openTagsRegExp);if(null==n)return null;for(const o of n){const n=o.replace(/^\s/,""),r=e.fullMatchRegExpByTag[n];if(null==r)continue;const i=t.match(r),s=e.transformersByTag[n];if(null!=i&&null!=s){if(!1!==s.intraword)return i;const{index:e=0}=i,n=t[e-1],o=t[e+i[0].length];if((!n||j.test(n))&&(!o||j.test(o)))return i}}return null}(o,e);if(!r)return void Z(t,n);let i,s,l;if(r[0]===o)i=t;else{const e=r.index||0,n=e+r[0].length;0===e?[i,s]=t.splitText(n):[l,i,s]=t.splitText(e,n)}i.setTextContent(r[2]);const c=e.transformersByTag[r[1]];if(c)for(const t of c.format)i.hasFormat(t)||i.toggleFormat(t);i.hasFormat("code")||Y(i,e,n),l&&Y(l,e,n),s&&Y(s,e,n)}function Z(t,e){let n=t;t:for(;n;){for(const t of e){if(!t.replace||!t.importRegExp)continue;const o=n.getTextContent().match(t.importRegExp);if(!o)continue;const r=o.index||0,i=t.getEndIndex?t.getEndIndex(n,o):r+o[0].length;if(!1===i)continue;let s,l;0===r?[s,n]=n.splitText(i):[,s,l]=n.splitText(r,i),l&&Z(l,e),t.replace(s,o);continue t}break}}function tt(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var et=tt((function(t){const e=new URLSearchParams;e.append("code",t);for(let t=1;t<arguments.length;t++)e.append("v",arguments[t]);throw Error(`Minified Lexical error #${t}; visit https://lexical.dev/docs/error?${e} for the full message or use the non-minified dev environment for full errors and additional helpful warnings.`)}));function nt(t,e,n){const o=n.length;for(let r=e;r>=o;r--){const e=r-o;if(ot(t,e,n,0,o)&&" "!==t[e+o])return e}return-1}function ot(t,e,n,o,r){for(let i=0;i<r;i++)if(t[e+i]!==n[o+i])return!1;return!0}function rt(t,n=At){const o=N(n),r=_(o.textFormat,(({tag:t})=>t[t.length-1])),l=_(o.textMatch,(({trigger:t})=>t));for(const e of n){const n=e.type;if("element"===n||"text-match"===n||"multiline-element"===n){const n=e.dependencies;for(const e of n)t.hasNode(e)||et(173,e.getType())}}const c=(t,n,c)=>{(function(t,e,n,o){const r=t.getParent();if(!u(r)||t.getFirstChild()!==e)return!1;const i=e.getTextContent();if(" "!==i[n-1])return!1;for(const{regExp:r,replace:s}of o){const o=i.match(r);if(o&&o[0].length===(o[0].endsWith(" ")?n:n-1)){const r=e.getNextSiblings(),[i,l]=e.splitText(n);if(i.remove(),!1!==s(t,l?[l,...r]:r,o,!1))return!0}}return!1})(t,n,c,o.element)||function(t,e,n,o){const r=t.getParent();if(!u(r)||t.getFirstChild()!==e)return!1;const i=e.getTextContent();if(" "!==i[n-1])return!1;for(const{regExpStart:r,replace:s,regExpEnd:l}of o){if(l&&!("optional"in l)||l&&"optional"in l&&!l.optional)continue;const o=i.match(r);if(o&&o[0].length===(o[0].endsWith(" ")?n:n-1)){const r=e.getNextSiblings(),[i,l]=e.splitText(n);if(i.remove(),!1!==s(t,l?[l,...r]:r,o,null,null,!1))return!0}}return!1}(t,n,c,o.multilineElement)||function(t,e,n){let o=t.getTextContent();const r=n[o[e-1]];if(null==r)return!1;e<o.length&&(o=o.slice(0,e));for(const e of r){if(!e.replace||!e.regExp)continue;const n=o.match(e.regExp);if(null===n)continue;const r=n.index||0,i=r+n[0].length;let s;return 0===r?[s]=t.splitText(i):[,s]=t.splitText(r,i),s.selectNext(0,0),e.replace(s,n),!0}return!1}(n,c,l)||function(t,n,o){const r=t.getTextContent(),l=n-1,c=r[l],a=o[c];if(!a)return!1;for(const n of a){const{tag:o}=n,a=o.length,u=l-a+1;if(a>1&&!ot(r,u,o,0,a))continue;if(" "===r[u-1])continue;const h=r[l+1];if(!1===n.intraword&&h&&!j.test(h))continue;const d=t;let m=d,x=nt(r,u,o),T=m;for(;x<0&&(T=T.getPreviousSibling())&&!i(T);)if(e(T)){const t=T.getTextContent();m=T,x=nt(t,t.length,o)}if(x<0)continue;if(m===d&&x+a===u)continue;const E=m.getTextContent();if(x>0&&E[x-1]===c)continue;const C=E[x-1];if(!1===n.intraword&&C&&!j.test(C))continue;const y=d.getTextContent(),v=y.slice(0,u)+y.slice(l+1);d.setTextContent(v);const b=m===d?v:E;m.setTextContent(b.slice(0,x)+b.slice(x+a));const S=s(),w=g();p(w);const $=l-a*(m===d?2:1)+1;w.anchor.set(m.__key,x,"text"),w.focus.set(d.__key,$,"text");for(const t of n.format)w.hasFormat(t)||w.formatText(t);w.anchor.set(w.focus.key,w.focus.offset,w.focus.type);for(const t of n.format)w.hasFormat(t)&&w.toggleFormat(t);return f(S)&&(w.format=S.format),!0}}(n,c,r)};return t.registerUpdateListener((({tags:n,dirtyLeaves:o,editorState:r,prevEditorState:i})=>{if(n.has("collaboration")||n.has("historic"))return;if(t.isComposing())return;const l=r.read(s),a=i.read(s);if(!f(a)||!f(l)||!l.isCollapsed()||l.is(a))return;const u=l.anchor.key,g=l.anchor.offset,p=r._nodeMap.get(u);!e(p)||!o.has(u)||1!==g&&g>a.anchor.offset+1||t.update((()=>{if(p.hasFormat("code"))return;const t=p.getParent();null===t||F(t)||c(t,p,l.anchor.offset)}))}))}const it=/^(\s*)(\d{1,})\.\s/,st=/^(\s*)[-*+]\s/,lt=/^(\s*)(?:-\s)?\s?(\[(\s|x)?\])\s/i,ct=/^(#{1,6})\s/,at=/^>\s/,ft=/^[ \t]*```(\w+)?/,ut=/[ \t]*```$/,gt=/^[ \t]*```[^`]+(?:(?:`{1,2}|`{4,})[^`]+)*```(?:[^`]|$)/,pt=/^(?:\|)(.+)(?:\|)\s?$/,ht=/^(\| ?:?-*:? ?)+\|\s?$/,dt=t=>(e,n,o)=>{const r=t(o);r.append(...n),e.replace(r),r.select(0,0)};const mt=t=>(e,n,o)=>{const r=e.getPreviousSibling(),i=e.getNextSibling(),s=T("check"===t?"x"===o[3]:void 0);if(h(i)&&i.getListType()===t){const t=i.getFirstChild();null!==t?t.insertBefore(s):i.append(s),e.remove()}else if(h(r)&&r.getListType()===t)r.append(s),e.remove();else{const n=E(t,"number"===t?Number(o[2]):void 0);n.append(s),e.replace(n)}s.append(...n),s.select(0,0);const l=function(t){const e=t.match(/\t/g),n=t.match(/ /g);let o=0;return e&&(o+=e.length),n&&(o+=Math.floor(n.length/4)),o}(o[1]);l&&s.setIndent(l)},xt=(t,e,n)=>{const o=[],r=t.getChildren();let i=0;for(const s of r)if(d(s)){if(1===s.getChildrenSize()){const t=s.getFirstChild();if(h(t)){o.push(xt(t,e,n+1));continue}}const r=" ".repeat(4*n),l=t.getListType(),c="number"===l?`${t.getStart()+i}. `:"check"===l?`- [${s.getChecked()?"x":" "}] `:"- ";o.push(r+c+e(s)),i++}return o.join("\n")},Tt={dependencies:[y],export:(t,e)=>{if(!v(t))return null;const n=Number(t.getTag().slice(1));return"#".repeat(n)+" "+e(t)},regExp:ct,replace:dt((t=>{const e="h"+t[1].length;return w(e)})),type:"element"},Et={dependencies:[b],export:(t,e)=>{if(!C(t))return null;const n=e(t).split("\n"),o=[];for(const t of n)o.push("> "+t);return o.join("\n")},regExp:at,replace:(t,e,n,o)=>{if(o){const n=t.getPreviousSibling();if(C(n))return n.splice(n.getChildrenSize(),0,[a(),...e]),n.select(0,0),void t.remove()}const r=S();r.append(...e),t.replace(r),r.select(0,0)},type:"element"},Ct={dependencies:[P],export:t=>{if(!F(t))return null;const e=t.getTextContent();return"```"+(t.getLanguage()||"")+(e?"\n"+e:"")+"\n```"},regExpEnd:{optional:!0,regExp:ut},regExpStart:ft,replace:(t,e,n,o,r,i)=>{let s,c;if(!e&&r){if(1===r.length)o?(s=k(),c=n[1]+r[0]):(s=k(n[1]),c=r[0].startsWith(" ")?r[0].slice(1):r[0]);else{if(s=k(n[1]),0===r[0].trim().length)for(;r.length>0&&!r[0].length;)r.shift();else r[0]=r[0].startsWith(" ")?r[0].slice(1):r[0];for(;r.length>0&&!r[r.length-1].length;)r.pop();c=r.join("\n")}const e=l(c);s.append(e),t.append(s)}else e&&dt((t=>k(t?t[1]:void 0)))(t,e,n,i)},type:"multiline-element"},yt={dependencies:[m,x],export:(t,e)=>h(t)?xt(t,e,0):null,regExp:st,replace:mt("bullet"),type:"element"},vt={dependencies:[m,x],export:(t,e)=>h(t)?xt(t,e,0):null,regExp:lt,replace:mt("check"),type:"element"},bt={dependencies:[m,x],export:(t,e)=>h(t)?xt(t,e,0):null,regExp:it,replace:mt("number"),type:"element"},St={format:["code"],tag:"`",type:"text-format"},wt={format:["highlight"],tag:"==",type:"text-format"},$t={format:["bold","italic"],tag:"***",type:"text-format"},Ft={format:["bold","italic"],intraword:!1,tag:"___",type:"text-format"},Pt={format:["bold"],tag:"**",type:"text-format"},kt={format:["bold"],intraword:!1,tag:"__",type:"text-format"},Mt={format:["strikethrough"],tag:"~~",type:"text-format"},Lt={format:["italic"],tag:"*",type:"text-format"},Rt={format:["italic"],intraword:!1,tag:"_",type:"text-format"},_t={dependencies:[M],export:(t,n,o)=>{if(!L(t))return null;const r=t.getTitle(),i=r?`[${t.getTextContent()}](${t.getURL()} "${r}")`:`[${t.getTextContent()}](${t.getURL()})`,s=t.getFirstChild();return 1===t.getChildrenSize()&&e(s)?o(s,i):i},importRegExp:/(?:\[([^[]+)\])(?:\((?:([^()\s]+)(?:\s"((?:[^"]*\\")*[^"]*)"\s*)?)\))/,regExp:/(?:\[([^[]+)\])(?:\((?:([^()\s]+)(?:\s"((?:[^"]*\\")*[^"]*)"\s*)?)\))$/,replace:(t,e)=>{const[,n,o,r]=e,i=R(o,{title:r}),s=l(n);s.setFormat(t.getFormat()),i.append(s),t.replace(i)},trigger:")",type:"text-match"};const Nt=[Tt,Et,yt,bt],jt=[Ct],It=[St,$t,Ft,Pt,kt,wt,Lt,Rt,Mt],zt=[_t],At=[...Nt,...jt,...It,...zt];function Bt(t,e=At,n,o=!1,r=!1){const i=o?t:function(t,e=!1){const n=t.split("\n");let o=!1;const r=[];for(let t=0;t<n.length;t++){const i=n[t],s=r[r.length-1];gt.test(i)?r.push(i):ft.test(i)||ut.test(i)?(o=!o,r.push(i)):o||""===i||""===s||!s||ct.test(s)||ct.test(i)||at.test(i)||it.test(i)||st.test(i)||lt.test(i)||pt.test(i)||ht.test(i)||!e?r.push(i):r[r.length-1]=s+i}return r.join("\n")}(t,r);return J(e,o)(i,n)}function Wt(t=At,e,o=!1){const r=function(t,e=!1){const o=N(t),r=[...o.multilineElement,...o.element],i=!e,s=o.textFormat.filter((t=>1===t.format.length));return t=>{const e=[],l=(t||n()).getChildren();for(let t=0;t<l.length;t++){const n=l[t],c=A(n,r,s,o.textMatch);null!=c&&e.push(i&&t>0&&!z(n)&&!z(l[t-1])?"\n".concat(c):c)}return e.join("\n")}}(t,o);return r(e)}export{Bt as $convertFromMarkdownString,Wt as $convertToMarkdownString,$t as BOLD_ITALIC_STAR,Ft as BOLD_ITALIC_UNDERSCORE,Pt as BOLD_STAR,kt as BOLD_UNDERSCORE,vt as CHECK_LIST,Ct as CODE,Nt as ELEMENT_TRANSFORMERS,Tt as HEADING,wt as HIGHLIGHT,St as INLINE_CODE,Lt as ITALIC_STAR,Rt as ITALIC_UNDERSCORE,_t as LINK,jt as MULTILINE_ELEMENT_TRANSFORMERS,bt as ORDERED_LIST,Et as QUOTE,Mt as STRIKETHROUGH,It as TEXT_FORMAT_TRANSFORMERS,zt as TEXT_MATCH_TRANSFORMERS,At as TRANSFORMERS,yt as UNORDERED_LIST,rt as registerMarkdownShortcuts};
