/**
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 *
 */

'use strict';var f=require("@lexical/react/LexicalComposerContext"),w=require("react"),x=require("@lexical/overflow"),z=require("@lexical/text"),A=require("@lexical/utils"),C=require("lexical"),D=require("react/jsx-runtime"),F;
function H(b){let d=new URLSearchParams;d.append("code",b);for(let r=1;r<arguments.length;r++)d.append("v",arguments[r]);throw Error(`Minified Lexical error #${b}; visit https://lexical.dev/docs/error?${d} for the full message or `+"use the non-minified dev environment for full errors and additional helpful warnings.");}F=H&&H.__esModule&&Object.prototype.hasOwnProperty.call(H,"default")?H["default"]:H;
function I(b,d,r=Object.freeze({})){let {strlen:l=m=>m.length,remainingCharacters:u=()=>{}}=r;w.useEffect(()=>{b.hasNodes([x.OverflowNode])||F(57)},[b]);w.useEffect(()=>{let m=b.getEditorState().read(z.$rootTextContent),n=0;return A.mergeRegister(b.registerTextContentListener(c=>{m=c}),b.registerUpdateListener(({dirtyLeaves:c,dirtyElements:p})=>{var k=b.isComposing();c=0<c.size||0<p.size;if(!k&&c){k=l(m);c=k>d||null!==n&&n>d;u(d-k);if(null===n||c){let t=J(m,d,l);b.update(()=>{let E=A.$dfs(),M=E.length,
y=0;for(let B=0;B<M;B+=1){var {node:a}=E[B];if(x.$isOverflowNode(a)){var e=y;if(y+a.getTextContentSize()<=t){var g=a.getParent();e=a.getPreviousSibling();var h=a.getNextSibling();A.$unwrapNode(a);a=C.$getSelection();!C.$isRangeSelection(a)||a.anchor.getNode().isAttached()&&a.focus.getNode().isAttached()||(C.$isTextNode(e)?e.select():C.$isTextNode(h)?h.select():null!==g&&g.select())}else e<t&&(g=a.getFirstDescendant(),h=null!==g?g.getTextContentSize():0,e+=h,g=C.$isTextNode(g)&&g.isSimpleText(),e=
e<=t,(g||e)&&A.$unwrapNode(a))}else if(C.$isLeafNode(a)&&(e=y,y+=a.getTextContentSize(),y>t&&!x.$isOverflowNode(a.getParent())&&(g=C.$getSelection(),e<t&&C.$isTextNode(a)&&a.isSimpleText()?([,a]=a.splitText(t-e),a=K(a)):a=K(a),null!==g&&C.$setSelection(g),e=a.getPreviousSibling(),x.$isOverflowNode(e)))){h=a.getFirstChild();var v=e.getChildren();g=v.length;if(null===h)a.append(...v);else for(var q=0;q<g;q++)h.insertBefore(v[q]);q=C.$getSelection();if(C.$isRangeSelection(q)){h=q.anchor;v=h.getNode();
q=q.focus;let G=h.getNode();v.is(e)?h.set(a.getKey(),h.offset,"element"):v.is(a)&&h.set(a.getKey(),g+h.offset,"element");G.is(e)?q.set(a.getKey(),q.offset,"element"):G.is(a)&&q.set(a.getKey(),g+q.offset,"element")}e.remove()}}},{tag:"history-merge"})}n=k}}),b.registerCommand(C.DELETE_CHARACTER_COMMAND,c=>{let p=C.$getSelection();if(!C.$isRangeSelection(p))return!1;var k=p.anchor.getNode().getParent();let t=(k=k?k.getParent():null)?k.getNextSibling():null;p.deleteCharacter(c);k&&k.isEmpty()?k.remove():
C.$isElementNode(t)&&t.isEmpty()&&t.remove();return!0},C.COMMAND_PRIORITY_LOW))},[b,d,u,l])}function J(b,d,r){var l=Intl.Segmenter;let u=0;var m=0;if("function"===typeof l){b=(new l).segment(b);for(var {segment:n}of b){m+=r(n);if(m>d)break;u+=n.length}}else for(n=Array.from(b),b=n.length,l=0;l<b;l++){let c=n[l];m+=r(c);if(m>d)break;u+=c.length}return u}function K(b){let d=x.$createOverflowNode();b.replace(d);d.append(b);return d}let L=null;
function N({remainingCharacters:b}){return D.jsx("span",{className:`characters-limit ${0>b?"characters-limit-exceeded":""}`,children:b})}
exports.CharacterLimitPlugin=function({charset:b="UTF-16",maxLength:d=5,renderer:r=N}){let [l]=f.useLexicalComposerContext(),[u,m]=w.useState(d),n=w.useMemo(()=>({remainingCharacters:m,strlen:c=>{if("UTF-8"===b){if(void 0===window.TextEncoder)var p=null;else null===L&&(L=new window.TextEncoder),p=L;null===p?(p=encodeURIComponent(c).match(/%[89ABab]/g),c=c.length+(p?p.length:0)):c=p.encode(c).length;return c}if("UTF-16"===b)return c.length;throw Error("Unrecognized charset");}}),[b]);I(l,d,n);return r({remainingCharacters:u})}
