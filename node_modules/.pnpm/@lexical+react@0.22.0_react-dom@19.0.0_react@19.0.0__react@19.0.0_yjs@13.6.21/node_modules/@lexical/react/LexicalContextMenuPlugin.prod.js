/**
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 *
 */

'use strict';var h=require("@lexical/react/LexicalComposerContext"),v=require("@lexical/utils"),z=require("lexical"),A=require("react"),B=require("react/jsx-runtime"),C=Object.create(null);if(A)for(var D in A)C[D]=A[D];C.default=A;let E="undefined"!==typeof window&&"undefined"!==typeof window.document&&"undefined"!==typeof window.document.createElement,F=E?A.useLayoutEffect:A.useEffect;
class G{constructor(b){this.key=b;this.ref={current:null};this.setRefElement=this.setRefElement.bind(this)}setRefElement(b){this.ref={current:b}}}let H=b=>{const a=document.getElementById("typeahead-menu");if(a){var g=a.getBoundingClientRect();g.top+g.height>window.innerHeight&&a.scrollIntoView({block:"center"});0>g.top&&a.scrollIntoView({block:"center"});b.scrollIntoView({block:"nearest"})}};
function I(b){var a=z.$getSelection();if(!z.$isRangeSelection(a)||!a.isCollapsed())return null;var g=a.anchor;if("text"!==g.type)return null;a=g.getNode();if(!a.isSimpleText())return null;g=g.offset;let l=a.getTextContent().slice(0,g);var f=b.matchingString;b=b.replaceableString.length;for(let k=b;k<=f.length;k++)l.substr(-k)===f.substr(0,k)&&(b=k);b=g-b;if(0>b)return null;let r;0===b?[r]=a.splitText(g):[,r]=a.splitText(b,g);return r}
function J(b){let a=getComputedStyle(b),g="absolute"===a.position,l=/(auto|scroll)/;if("fixed"===a.position)return document.body;for(;b=b.parentElement;)if(a=getComputedStyle(b),(!g||"static"!==a.position)&&l.test(a.overflow+a.overflowY+a.overflowX))return b;return document.body}function K(b,a){b=b.getBoundingClientRect();a=a.getBoundingClientRect();return b.top>a.top&&b.top<a.bottom}
function L(b,a,g,l){let [f]=h.useLexicalComposerContext();A.useEffect(()=>{if(null!=a&&null!=b){let r=f.getRootElement(),k=null!=r?J(r):document.body,u=!1,t=K(a,k),e=function(){u||(window.requestAnimationFrame(function(){g();u=!1}),u=!0);const n=K(a,k);n!==t&&(t=n,null!=l&&l(n))},c=new ResizeObserver(g);window.addEventListener("resize",g);document.addEventListener("scroll",e,{capture:!0,passive:!0});c.observe(a);return()=>{c.unobserve(a);window.removeEventListener("resize",g);document.removeEventListener("scroll",
e,!0)}}},[a,f,l,g,b])}let M=z.createCommand("SCROLL_TYPEAHEAD_OPTION_INTO_VIEW_COMMAND");
function N({close:b,editor:a,anchorElementRef:g,resolution:l,options:f,menuRenderFn:r,onSelectOption:k,shouldSplitNodeWithQuery:u=!1,commandPriority:t=z.COMMAND_PRIORITY_LOW}){let [e,c]=A.useState(null);A.useEffect(()=>{c(0)},[l.match&&l.match.matchingString]);let n=A.useCallback(d=>{a.update(()=>{const p=null!=l.match&&u?I(l.match):null;k(d,p,b,l.match?l.match.matchingString:"")})},[a,u,l.match,k,b]),q=A.useCallback(d=>{const p=a.getRootElement();null!==p&&(p.setAttribute("aria-activedescendant",
"typeahead-item-"+d),c(d))},[a]);A.useEffect(()=>()=>{let d=a.getRootElement();null!==d&&d.removeAttribute("aria-activedescendant")},[a]);F(()=>{null===f?c(null):null===e&&q(0)},[f,e,q]);A.useEffect(()=>v.mergeRegister(a.registerCommand(M,({option:d})=>d.ref&&null!=d.ref.current?(H(d.ref.current),!0):!1,t)),[a,q,t]);A.useEffect(()=>v.mergeRegister(a.registerCommand(z.KEY_ARROW_DOWN_COMMAND,d=>{if(null!==f&&f.length&&null!==e){let p=e!==f.length-1?e+1:0;q(p);let w=f[p];null!=w.ref&&w.ref.current&&
a.dispatchCommand(M,{index:p,option:w});d.preventDefault();d.stopImmediatePropagation()}return!0},t),a.registerCommand(z.KEY_ARROW_UP_COMMAND,d=>{if(null!==f&&f.length&&null!==e){var p=0!==e?e-1:f.length-1;q(p);p=f[p];null!=p.ref&&p.ref.current&&H(p.ref.current);d.preventDefault();d.stopImmediatePropagation()}return!0},t),a.registerCommand(z.KEY_ESCAPE_COMMAND,d=>{d.preventDefault();d.stopImmediatePropagation();b();return!0},t),a.registerCommand(z.KEY_TAB_COMMAND,d=>{if(null===f||null===e||null==
f[e])return!1;d.preventDefault();d.stopImmediatePropagation();n(f[e]);return!0},t),a.registerCommand(z.KEY_ENTER_COMMAND,d=>{if(null===f||null===e||null==f[e])return!1;null!==d&&(d.preventDefault(),d.stopImmediatePropagation());n(f[e]);return!0},t)),[n,b,a,f,e,q,t]);let x=A.useMemo(()=>({options:f,selectOptionAndCleanUp:n,selectedIndex:e,setHighlightedIndex:c}),[n,e,f]);return r(g,x,l.match?l.match.matchingString:"")}
function O(b,a,g,l=E?document.body:void 0,f=!0){let [r]=h.useLexicalComposerContext(),k=A.useRef(E?document.createElement("div"):null),u=A.useCallback(()=>{if(null!==k.current&&void 0!==l){k.current.style.top=k.current.style.bottom;var e=r.getRootElement(),c=k.current,n=c.firstChild;if(null!==e&&null!==b){const {left:x,top:d,width:p,height:w}=b.getRect();c.style.top=`${d+k.current.offsetHeight+3+(f?window.pageYOffset:0)}px`;c.style.left=`${x+window.pageXOffset}px`;c.style.height=`${w}px`;c.style.width=
`${p}px`;if(null!==n){n.style.top=`${d}`;var q=n.getBoundingClientRect();n=q.height;q=q.width;const m=e.getBoundingClientRect();x+q>m.right&&(c.style.left=`${m.right-q+window.pageXOffset}px`);(d+n>window.innerHeight||d+n>m.bottom)&&d-m.top>n+w&&(c.style.top=`${d-n-w+(f?window.pageYOffset:0)}px`)}c.isConnected||(null!=g&&(c.className=g),c.setAttribute("aria-label","Typeahead menu"),c.setAttribute("id","typeahead-menu"),c.setAttribute("role","listbox"),c.style.display="block",c.style.position="absolute",
l.append(c));k.current=c;e.setAttribute("aria-controls","typeahead-menu")}}},[r,b,f,g,l]);A.useEffect(()=>{let e=r.getRootElement();if(null!==b)return u(),()=>{null!==e&&e.removeAttribute("aria-controls");let c=k.current;null!==c&&c.isConnected&&c.remove()}},[r,u,b]);let t=A.useCallback(e=>{null!==b&&(e||a(null))},[b,a]);L(b,k.current,u,t);return k}
exports.LexicalContextMenuPlugin=function({options:b,onWillOpen:a,onClose:g,onOpen:l,onSelectOption:f,menuRenderFn:r,anchorClassName:k,commandPriority:u=z.COMMAND_PRIORITY_LOW,parent:t}){let [e]=h.useLexicalComposerContext(),[c,n]=A.useState(null),q=C.useRef(null);k=O(c,n,k,t);let x=A.useCallback(()=>{n(null);null!=g&&null!==c&&g()},[g,c]),d=A.useCallback(m=>{n(m);null!=l&&null===c&&l(m)},[l,c]),p=A.useCallback(m=>{m.preventDefault();null!=a&&a(m);const y=v.calculateZoomLevel(m.target);d({getRect:()=>
new DOMRect(m.clientX/y,m.clientY/y,1,1)})},[d,a]),w=A.useCallback(m=>{null!==c&&null!=q.current&&null!=m.target&&z.isDOMNode(m.target)&&!q.current.contains(m.target)&&x()},[x,c]);A.useEffect(()=>{let m=e.getRootElement();if(m)return m.addEventListener("contextmenu",p),()=>m.removeEventListener("contextmenu",p)},[e,p]);A.useEffect(()=>{document.addEventListener("click",w);return()=>document.removeEventListener("click",w)},[e,w]);return null===k.current||null===c||null===e?null:B.jsx(N,{close:x,resolution:c,
editor:e,anchorElementRef:k,options:b,menuRenderFn:(m,y)=>r(m,y,{setMenuRef:P=>{q.current=P}}),onSelectOption:f,commandPriority:u})};exports.MenuOption=G
