/**
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 *
 */

'use strict';var u=require("@lexical/react/LexicalComposerContext"),v=require("@lexical/rich-text"),z=require("@lexical/utils"),A=require("lexical"),C=require("react"),D=require("react-dom"),E=require("react/jsx-runtime");
class F{constructor(a,b){this._x=a;this._y=b}get x(){return this._x}get y(){return this._y}equals({x:a,y:b}){return this.x===a&&this.y===b}calcDeltaXTo({x:a}){return this.x-a}calcDeltaYTo({y:a}){return this.y-a}calcHorizontalDistanceTo(a){return Math.abs(this.calcDeltaXTo(a))}calcVerticalDistance(a){return Math.abs(this.calcDeltaYTo(a))}calcDistanceTo(a){return Math.sqrt(Math.pow(this.calcDeltaXTo(a),2)+Math.pow(this.calcDeltaYTo(a),2))}}
class G{constructor(a,b,c,d){let [n,h]=b<=d?[b,d]:[d,b],[l,g]=a<=c?[a,c]:[c,a];this._top=n;this._right=g;this._left=l;this._bottom=h}get top(){return this._top}get right(){return this._right}get bottom(){return this._bottom}get left(){return this._left}get width(){return Math.abs(this._left-this._right)}get height(){return Math.abs(this._bottom-this._top)}equals({top:a,left:b,bottom:c,right:d}){return a===this._top&&c===this._bottom&&b===this._left&&d===this._right}contains(a){if(a instanceof F){let {x:h,
y:l}=a;a=l<this._top;let g=l>this._bottom,m=h<this._left,t=h>this._right;return{reason:{isOnBottomSide:g,isOnLeftSide:m,isOnRightSide:t,isOnTopSide:a},result:!a&&!g&&!m&&!t}}let {top:b,left:c,bottom:d,right:n}=a;return b>=this._top&&b<=this._bottom&&d>=this._top&&d<=this._bottom&&c>=this._left&&c<=this._right&&n>=this._left&&n<=this._right}intersectsWith(a){let {left:b,top:c,width:d,height:n}=a,{left:h,top:l,width:g,height:m}=this;return(b+d>=h+g?b+d:h+g)-(b<=h?b:h)<=d+g&&(c+n>=l+m?c+n:l+m)-(c<=l?
c:l)<=n+m}generateNewRect({left:a=this.left,top:b=this.top,right:c=this.right,bottom:d=this.bottom}){return new G(a,b,c,d)}static fromLTRB(a,b,c,d){return new G(a,b,c,d)}static fromLWTH(a,b,c,d){return new G(a,c,a+b,c+d)}static fromPoints(a,b){let {y:c,x:d}=a,{y:n,x:h}=b;return G.fromLTRB(d,c,h,n)}static fromDOM(a){let {top:b,width:c,left:d,height:n}=a.getBoundingClientRect();return G.fromLWTH(d,c,b,n)}}let H=Infinity;
function J(a){return a.getEditorState().read(()=>A.$getRoot().getChildrenKeys())}function K(a){let {marginTop:b,marginBottom:c}=window.getComputedStyle(a);var d=(d=a.previousElementSibling)?parseFloat(window.getComputedStyle(d).marginBottom):0;a=(a=a.nextElementSibling)?parseFloat(window.getComputedStyle(a).marginTop):0;d=Math.max(parseFloat(b),d);return{marginBottom:Math.max(parseFloat(c),a),marginTop:d}}
function L(a,b,c,d=!1){let n=a.getBoundingClientRect(),h=J(b),l=null;b.getEditorState().read(()=>{if(d){let [q,f]=[b.getElementByKey(h[0]),b.getElementByKey(h[h.length-1])],[p,e]=[null!=q?q.getBoundingClientRect():void 0,null!=f?f.getBoundingClientRect():void 0];if(p&&e){var g=z.calculateZoomLevel(q),m=z.calculateZoomLevel(f);c.y/g<p.top?l=q:c.y/m>e.bottom&&(l=f);if(l)return}}g=h.length;g=0===g?Infinity:0<=H&&H<g?H:Math.floor(g/2);for(m=0;0<=g&&g<h.length;){let q=b.getElementByKey(h[g]);if(null===
q)break;var t=z.calculateZoomLevel(q);t=new F(c.x/t,c.y/t);var r=G.fromDOM(q);let {marginTop:f,marginBottom:p}=K(q);r=r.generateNewRect({bottom:r.bottom+p,left:n.left,right:n.right,top:r.top-f});let {result:e,reason:{isOnTopSide:k,isOnBottomSide:w}}=r.contains(t);if(e){l=q;H=g;break}0===m&&(m=k?-1:w?1:Infinity);g+=m}});return l}function M(a,b){let {transform:c}=b.style;b.style.transform="translateZ(0)";a.setDragImage(b,0,0);setTimeout(()=>{b.style.transform=c})}
function N(a,b,c,d,n,h,l,g){let m=b.parentElement,t=C.useRef(!1),[r,q]=C.useState(null);C.useEffect(()=>{function f(e){let k=e.target;z.isHTMLElement(k)?g(k)||(e=L(b,a,e),q(e)):q(null)}function p(){q(null)}null!=m&&(m.addEventListener("mousemove",f),m.addEventListener("mouseleave",p));return()=>{null!=m&&(m.removeEventListener("mousemove",f),m.removeEventListener("mouseleave",p))}},[m,b,a,g]);C.useEffect(()=>{if(c.current){var f=c.current;if(r){var p=r.getBoundingClientRect(),e=window.getComputedStyle(r),
k=f.getBoundingClientRect(),w=b.getBoundingClientRect();e=parseInt(e.lineHeight,10);isNaN(e)&&(e=p.bottom-p.top);p=p.top+(e-k.height)/2-w.top;f.style.opacity="1";f.style.transform=`translate(${4}px, ${p}px)`}else f.style.opacity="0",f.style.transform="translate(-10000px, -10000px)"}},[b,r,c]);C.useEffect(()=>{function f(e){if(!t.current)return!1;var [k]=v.eventFiles(e);if(k)return!1;let {pageY:w,target:B}=e;if(!z.isHTMLElement(B))return!1;var x=L(b,a,e,!0);k=d.current;if(null===x||null===k)return!1;
var y=w/z.calculateZoomLevel(B);let {top:I,height:O}=x.getBoundingClientRect(),{top:P,width:Q}=b.getBoundingClientRect(),{marginTop:R,marginBottom:S}=K(x);x=I;k.style.transform=`translate(${24}px, ${(y>=I?x+(O+S/2):x-R/2)-P-2}px)`;k.style.width=`${Q-48}px`;k.style.opacity=".4";e.preventDefault();return!0}function p(e){if(!t.current)return!1;var [k]=v.eventFiles(e);if(k)return!1;let {target:w,dataTransfer:B,pageY:x}=e;k=null!=B?B.getData("application/x-lexical-drag-block"):"";k=A.$getNodeByKey(k);
if(!k||!z.isHTMLElement(w))return!1;var y=L(b,a,e,!0);if(!y)return!1;e=A.$getNearestNodeFromDOMNode(y);if(!e)return!1;if(e===k)return!0;y=y.getBoundingClientRect().top;x/z.calculateZoomLevel(w)>=y?e.insertAfter(k):e.insertBefore(k);q(null);return!0}return z.mergeRegister(a.registerCommand(A.DRAGOVER_COMMAND,e=>f(e),A.COMMAND_PRIORITY_LOW),a.registerCommand(A.DROP_COMMAND,e=>p(e),A.COMMAND_PRIORITY_HIGH))},[b,a,d]);return D.createPortal(E.jsxs(E.Fragment,{children:[E.jsx("div",{draggable:!0,onDragStart:function(f){if((f=
f.dataTransfer)&&r){M(f,r);var p="";a.update(()=>{let e=A.$getNearestNodeFromDOMNode(r);e&&(p=e.getKey())});t.current=!0;f.setData("application/x-lexical-drag-block",p)}},onDragEnd:function(){t.current=!1;var f=d.current;f&&(f.style.opacity="0",f.style.transform="translate(-10000px, -10000px)")},children:n&&h}),l]}),b)}
exports.DraggableBlockPlugin_EXPERIMENTAL=function({anchorElem:a=document.body,menuRef:b,targetLineRef:c,menuComponent:d,targetLineComponent:n,isOnMenu:h}){let [l]=u.useLexicalComposerContext();return N(l,a,b,c,l._editable,d,n,h)}
