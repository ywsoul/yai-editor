/**
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 *
 */

'use strict';var m=require("@lexical/react/LexicalComposerContext"),u=require("lexical"),y=require("react"),z=require("@lexical/utils"),A=require("react/jsx-runtime");function B(b){"startTransition"in y?y.startTransition(b):b()}let C="undefined"!==typeof window&&"undefined"!==typeof window.document&&"undefined"!==typeof window.document.createElement,D=C?y.useLayoutEffect:y.useEffect;
class E{constructor(b){this.key=b;this.ref={current:null};this.setRefElement=this.setRefElement.bind(this)}setRefElement(b){this.ref={current:b}}}let F=b=>{const a=document.getElementById("typeahead-menu");if(a){var g=a.getBoundingClientRect();g.top+g.height>window.innerHeight&&a.scrollIntoView({block:"center"});0>g.top&&a.scrollIntoView({block:"center"});b.scrollIntoView({block:"nearest"})}};
function G(b){var a=u.$getSelection();if(!u.$isRangeSelection(a)||!a.isCollapsed())return null;var g=a.anchor;if("text"!==g.type)return null;a=g.getNode();if(!a.isSimpleText())return null;g=g.offset;let k=a.getTextContent().slice(0,g);var f=b.matchingString;b=b.replaceableString.length;for(let h=b;h<=f.length;h++)k.substr(-h)===f.substr(0,h)&&(b=h);b=g-b;if(0>b)return null;let q;0===b?[q]=a.splitText(g):[,q]=a.splitText(b,g);return q}
function H(b){let a=getComputedStyle(b),g="absolute"===a.position,k=/(auto|scroll)/;if("fixed"===a.position)return document.body;for(;b=b.parentElement;)if(a=getComputedStyle(b),(!g||"static"!==a.position)&&k.test(a.overflow+a.overflowY+a.overflowX))return b;return document.body}function I(b,a){b=b.getBoundingClientRect();a=a.getBoundingClientRect();return b.top>a.top&&b.top<a.bottom}
function J(b,a,g,k){let [f]=m.useLexicalComposerContext();y.useEffect(()=>{if(null!=a&&null!=b){let q=f.getRootElement(),h=null!=q?H(q):document.body,t=!1,r=I(a,h),e=function(){t||(window.requestAnimationFrame(function(){g();t=!1}),t=!0);const n=I(a,h);n!==r&&(r=n,null!=k&&k(n))},c=new ResizeObserver(g);window.addEventListener("resize",g);document.addEventListener("scroll",e,{capture:!0,passive:!0});c.observe(a);return()=>{c.unobserve(a);window.removeEventListener("resize",g);document.removeEventListener("scroll",
e,!0)}}},[a,f,k,g,b])}let K=u.createCommand("SCROLL_TYPEAHEAD_OPTION_INTO_VIEW_COMMAND");
function L({close:b,editor:a,anchorElementRef:g,resolution:k,options:f,menuRenderFn:q,onSelectOption:h,shouldSplitNodeWithQuery:t=!1,commandPriority:r=u.COMMAND_PRIORITY_LOW}){let [e,c]=y.useState(null);y.useEffect(()=>{c(0)},[k.match&&k.match.matchingString]);let n=y.useCallback(d=>{a.update(()=>{const l=null!=k.match&&t?G(k.match):null;h(d,l,b,k.match?k.match.matchingString:"")})},[a,t,k.match,h,b]),p=y.useCallback(d=>{const l=a.getRootElement();null!==l&&(l.setAttribute("aria-activedescendant",
"typeahead-item-"+d),c(d))},[a]);y.useEffect(()=>()=>{let d=a.getRootElement();null!==d&&d.removeAttribute("aria-activedescendant")},[a]);D(()=>{null===f?c(null):null===e&&p(0)},[f,e,p]);y.useEffect(()=>z.mergeRegister(a.registerCommand(K,({option:d})=>d.ref&&null!=d.ref.current?(F(d.ref.current),!0):!1,r)),[a,p,r]);y.useEffect(()=>z.mergeRegister(a.registerCommand(u.KEY_ARROW_DOWN_COMMAND,d=>{if(null!==f&&f.length&&null!==e){let l=e!==f.length-1?e+1:0;p(l);let v=f[l];null!=v.ref&&v.ref.current&&
a.dispatchCommand(K,{index:l,option:v});d.preventDefault();d.stopImmediatePropagation()}return!0},r),a.registerCommand(u.KEY_ARROW_UP_COMMAND,d=>{if(null!==f&&f.length&&null!==e){var l=0!==e?e-1:f.length-1;p(l);l=f[l];null!=l.ref&&l.ref.current&&F(l.ref.current);d.preventDefault();d.stopImmediatePropagation()}return!0},r),a.registerCommand(u.KEY_ESCAPE_COMMAND,d=>{d.preventDefault();d.stopImmediatePropagation();b();return!0},r),a.registerCommand(u.KEY_TAB_COMMAND,d=>{if(null===f||null===e||null==
f[e])return!1;d.preventDefault();d.stopImmediatePropagation();n(f[e]);return!0},r),a.registerCommand(u.KEY_ENTER_COMMAND,d=>{if(null===f||null===e||null==f[e])return!1;null!==d&&(d.preventDefault(),d.stopImmediatePropagation());n(f[e]);return!0},r)),[n,b,a,f,e,p,r]);let w=y.useMemo(()=>({options:f,selectOptionAndCleanUp:n,selectedIndex:e,setHighlightedIndex:c}),[n,e,f]);return q(g,w,k.match?k.match.matchingString:"")}
function M(b,a,g,k=C?document.body:void 0,f=!0){let [q]=m.useLexicalComposerContext(),h=y.useRef(C?document.createElement("div"):null),t=y.useCallback(()=>{if(null!==h.current&&void 0!==k){h.current.style.top=h.current.style.bottom;var e=q.getRootElement(),c=h.current,n=c.firstChild;if(null!==e&&null!==b){const {left:w,top:d,width:l,height:v}=b.getRect();c.style.top=`${d+h.current.offsetHeight+3+(f?window.pageYOffset:0)}px`;c.style.left=`${w+window.pageXOffset}px`;c.style.height=`${v}px`;c.style.width=
`${l}px`;if(null!==n){n.style.top=`${d}`;var p=n.getBoundingClientRect();n=p.height;p=p.width;const x=e.getBoundingClientRect();w+p>x.right&&(c.style.left=`${x.right-p+window.pageXOffset}px`);(d+n>window.innerHeight||d+n>x.bottom)&&d-x.top>n+v&&(c.style.top=`${d-n-v+(f?window.pageYOffset:0)}px`)}c.isConnected||(null!=g&&(c.className=g),c.setAttribute("aria-label","Typeahead menu"),c.setAttribute("id","typeahead-menu"),c.setAttribute("role","listbox"),c.style.display="block",c.style.position="absolute",
k.append(c));h.current=c;e.setAttribute("aria-controls","typeahead-menu")}}},[q,b,f,g,k]);y.useEffect(()=>{let e=q.getRootElement();if(null!==b)return t(),()=>{null!==e&&e.removeAttribute("aria-controls");let c=h.current;null!==c&&c.isConnected&&c.remove()}},[q,t,b]);let r=y.useCallback(e=>{null!==b&&(e||a(null))},[b,a]);J(b,h.current,t,r);return h}
exports.LexicalNodeMenuPlugin=function({options:b,nodeKey:a,onClose:g,onOpen:k,onSelectOption:f,menuRenderFn:q,anchorClassName:h,commandPriority:t=u.COMMAND_PRIORITY_LOW,parent:r}){let [e]=m.useLexicalComposerContext(),[c,n]=y.useState(null);h=M(c,n,h,r);let p=y.useCallback(()=>{n(null);null!=g&&null!==c&&g()},[g,c]),w=y.useCallback(l=>{n(l);null!=k&&null===c&&k(l)},[k,c]),d=y.useCallback(()=>{a?e.update(()=>{const l=u.$getNodeByKey(a),v=e.getElementByKey(a);null!=l&&null!=v&&null==c&&B(()=>w({getRect:()=>
v.getBoundingClientRect()}))}):null==a&&null!=c&&p()},[p,e,a,w,c]);y.useEffect(()=>{d()},[d,a]);y.useEffect(()=>{if(null!=a)return e.registerUpdateListener(({dirtyElements:l})=>{l.get(a)&&d()})},[e,d,a]);return null===h.current||null===c||null===e?null:A.jsx(L,{close:p,resolution:c,editor:e,anchorElementRef:h,options:b,menuRenderFn:q,onSelectOption:f,commandPriority:t})};exports.MenuOption=E
